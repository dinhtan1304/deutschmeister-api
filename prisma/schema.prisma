generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String?
  avatar          String?
  role            String    @default("user") // "user" | "admin"
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  settings        Settings?
  favorites       Favorite[]
  history         History[]
  gameSessions    GameSession[]
  progress        Progress[]
  refreshTokens   RefreshToken[]
  personalWords   PersonalWord[]
  topicProgress   TopicProgress[]
  writingSessions WritingSession[]
  grammarProgress GrammarProgress[]
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("refresh_tokens")
}

model Settings {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme            String   @default("system")
  soundEnabled     Boolean  @default(true) @map("sound_enabled")
  vibrationEnabled Boolean  @default(true) @map("vibration_enabled")
  dailyGoal        Int      @default(20) @map("daily_goal")
  preferredLevel   String   @default("A1") @map("preferred_level")
  showVietnamese   Boolean  @default(true) @map("show_vietnamese")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model Word {
  id            String   @id @default(cuid())
  word          String
  article       String
  gender        String
  plural        String?
  pronunciation String?
  imageUrl      String?  @map("image_url")
  translationEn String   @map("translation_en")
  translationVi String?  @map("translation_vi")
  category      String
  level         String
  frequency     Int      @default(0)
  examples      String[]
  tips          String[]
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  favorites     Favorite[]
  history       History[]
  progress      Progress[]
  gameAnswers   GameAnswer[]
  topicWords    TopicWord[]

  @@index([gender])
  @@index([category])
  @@index([level])
  @@index([word])
  @@map("words")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wordId    String   @map("word_id")
  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, wordId])
  @@index([userId])
  @@map("favorites")
}

model History {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wordId    String   @map("word_id")
  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now()) @map("viewed_at")

  @@index([userId, viewedAt])
  @@map("history")
}

model GameSession {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameType       String       @map("game_type")
  difficulty     String
  category       String?
  score          Int          @default(0)
  correctAnswers Int          @default(0) @map("correct_answers")
  wrongAnswers   Int          @default(0) @map("wrong_answers")
  totalQuestions Int          @default(0) @map("total_questions")
  bestStreak     Int          @default(0) @map("best_streak")
  startedAt      DateTime     @default(now()) @map("started_at")
  endedAt        DateTime?    @map("ended_at")
  duration       Int?
  answers        GameAnswer[]

  @@index([userId, gameType])
  @@index([userId, startedAt])
  @@map("game_sessions")
}

model GameAnswer {
  id             String      @id @default(cuid())
  sessionId      String      @map("session_id")
  session        GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  wordId         String      @map("word_id")
  word           Word        @relation(fields: [wordId], references: [id])
  selectedAnswer String      @map("selected_answer")
  correctAnswer  String      @map("correct_answer")
  isCorrect      Boolean     @map("is_correct")
  responseTime   Int         @map("response_time")
  createdAt      DateTime    @default(now()) @map("created_at")

  @@index([sessionId])
  @@map("game_answers")
}

model Progress {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  wordId       String    @map("word_id")
  word         Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)
  easeFactor   Float     @default(2.5) @map("ease_factor")
  interval     Int       @default(0)
  repetitions  Int       @default(0)
  nextReviewAt DateTime  @default(now()) @map("next_review_at")
  lastReviewAt DateTime? @map("last_review_at")
  totalReviews Int       @default(0) @map("total_reviews")
  correctCount Int       @default(0) @map("correct_count")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@unique([userId, wordId])
  @@index([userId, nextReviewAt])
  @@map("progress")
}

// ============== PERSONAL WORD BANK ==============
model PersonalWord {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  word            String
  wordType        String   @map("word_type") // nomen, verb, adjektiv, adverb, praposition, konjunktion, pronomen, partikel, andere

  // Type-specific data (JSON)
  nomenData       Json?    @map("nomen_data")       // { article, gender, plural }
  verbData        Json?    @map("verb_data")         // { partizipII, hilfsverb, trennbar, prateritum, konjugation }
  adjektivData    Json?    @map("adjektiv_data")     // { komparativ, superlativ }
  prapositionData Json?    @map("praposition_data")  // { kasus[] }

  translationEn   String   @map("translation_en")
  translationVi   String   @map("translation_vi")

  examples        String[] @default([])
  level           String   @default("A1")
  category        String?
  tags            String[] @default([])
  notes           String?
  pronunciation   String?

  isFavorite      Boolean  @default(false) @map("is_favorite")
  
  // ============== SRS Fields ==============
  easeFactor      Float    @default(2.5) @map("ease_factor")    // SM-2 ease factor (min 1.3)
  interval        Int      @default(0)                          // Days until next review
  repetitions     Int      @default(0)                          // Consecutive correct reviews
  nextReviewAt    DateTime @default(now()) @map("next_review_at")
  lastReviewAt    DateTime? @map("last_review_at")
  totalReviews    Int      @default(0) @map("total_reviews")
  correctCount    Int      @default(0) @map("correct_count")
  // =========================================

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([userId, word, wordType]) // Prevent duplicate word+type per user
  @@index([userId])
  @@index([userId, wordType])
  @@index([userId, level])
  @@index([userId, isFavorite])
  @@index([userId, nextReviewAt])  // Index for SRS queries
  @@map("personal_words")
}
// ============================================
// VOCABULARY TOPICS - Th√™m v√†o schema.prisma
// ============================================

// Ch·ªß ƒë·ªÅ t·ª´ v·ª±ng (12 ch·ªß ƒë·ªÅ A1)
model Topic {
  id            String   @id @default(cuid())
  slug          String   @unique // "wohnen", "essen-trinken"
  
  // Names
  nameDe        String   @map("name_de")      // "Wohnen"
  nameEn        String   @map("name_en")      // "Housing"
  nameVi        String   @map("name_vi")      // "Nh√† ·ªü"
  
  // Descriptions
  descriptionDe String?  @map("description_de")
  descriptionEn String?  @map("description_en")
  descriptionVi String?  @map("description_vi")
  
  // Metadata
  icon          String?  // Emoji: üè†
  color         String?  // Hex: #4CAF50
  imageUrl      String?  @map("image_url")
  level         String   @default("A1") // CEFR level
  order         Int      @default(0) // Th·ª© t·ª± hi·ªÉn th·ªã
  isActive      Boolean  @default(true) @map("is_active")
  
  // Stats (cached, updated by trigger/cron)
  wordCount     Int      @default(0) @map("word_count")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  topicWords    TopicWord[]
  userProgress  TopicProgress[]
  
  @@index([level])
  @@index([order])
  @@map("topics")
}

// Junction table: Topic ‚Üî Word (many-to-many)
model TopicWord {
  id        String   @id @default(cuid())
  topicId   String   @map("topic_id")
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  wordId    String   @map("word_id")
  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
  
  order     Int      @default(0) // Th·ª© t·ª± trong topic
  isCore    Boolean  @default(false) @map("is_core") // T·ª´ c·ªët l√µi c·ªßa topic
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@unique([topicId, wordId])
  @@index([topicId])
  @@index([wordId])
  @@map("topic_words")
}

// User progress per topic
model TopicProgress {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId         String    @map("topic_id")
  topic           Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  
  wordsLearned    Int       @default(0) @map("words_learned")
  wordsTotal      Int       @default(0) @map("words_total")
  masteryPercent  Float     @default(0) @map("mastery_percent") // 0-100
  
  lastStudiedAt   DateTime? @map("last_studied_at")
  completedAt     DateTime? @map("completed_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@unique([userId, topicId])
  @@index([userId])
  @@map("topic_progress")
}

model WritingSession {
  id            String        @id @default(cuid())
  userId        String        @map("user_id")
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ‚îÄ‚îÄ C·∫•u h√¨nh ƒë·ªÅ b√†i ‚îÄ‚îÄ
  topic         String                  // Ch·ªß ƒë·ªÅ: "Wohnung", "Einkaufen", ho·∫∑c custom
  cefrLevel     String        @map("cefr_level")    // A1, A2, B1, B2
  writingType   String        @map("writing_type")  // email, brief, beschreibung...
  wordCountMin  Int           @map("word_count_min")
  wordCountMax  Int           @map("word_count_max")

  // ‚îÄ‚îÄ ƒê·ªÅ b√†i do AI t·∫°o ‚îÄ‚îÄ
  prompt        String        @db.Text              // ƒê·ªÅ b√†i ti·∫øng ƒê·ª©c
  vocabHints    Json?         @map("vocab_hints")   // ["die Wohnung (cƒÉn h·ªô)", ...]
  grammarHints  Json?         @map("grammar_hints") // ["sein + Adjektiv (l√† + t√≠nh t·ª´)", ...]

  // ‚îÄ‚îÄ B√†i vi·∫øt c·ªßa user ‚îÄ‚îÄ
  userText      String?       @map("user_text") @db.Text
  wordCount     Int?          @map("word_count")
  submittedAt   DateTime?     @map("submitted_at")

  // ‚îÄ‚îÄ K·∫øt qu·∫£ ch·∫•m b√†i ‚îÄ‚îÄ
  overallScore  Float?        @map("overall_score")   // 0-100
  correctedText String?       @map("corrected_text") @db.Text
  feedbackDe    String?       @map("feedback_de") @db.Text     // Nh·∫≠n x√©t ti·∫øng ƒê·ª©c
  feedbackVi    String?       @map("feedback_vi") @db.Text     // Nh·∫≠n x√©t ti·∫øng Vi·ªát
  strengths     Json?                                           // ["Guter Wortschatz", ...]
  improvements  Json?                                           // ["Artikel √ºben", ...]
  gradedAt      DateTime?     @map("graded_at")

  // ‚îÄ‚îÄ Tr·∫°ng th√°i ‚îÄ‚îÄ
  status        String        @default("DRAFT")     // DRAFT, SUBMITTED, GRADING, GRADED, ERROR

  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  errors        WritingError[]

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("writing_sessions")
}

model WritingError {
  id               String         @id @default(cuid())
  writingSessionId String         @map("writing_session_id")
  session          WritingSession @relation(fields: [writingSessionId], references: [id], onDelete: Cascade)

  errorType      String   @map("error_type")       // article, grammar, word_order, conjugation, case, spelling, vocabulary
  severity       String                             // error, warning, suggestion
  originalText   String   @map("original_text")     // ƒêo·∫°n sai
  correctedText  String   @map("corrected_text")    // ƒêo·∫°n ƒë√∫ng
  explanationDe  String   @map("explanation_de") @db.Text  // Gi·∫£i th√≠ch ti·∫øng ƒê·ª©c
  explanationVi  String   @map("explanation_vi") @db.Text  // Gi·∫£i th√≠ch ti·∫øng Vi·ªát
  position       Int?                               // V·ªã tr√≠ trong b√†i (character index)

  createdAt      DateTime @default(now()) @map("created_at")

  @@index([writingSessionId])
  @@index([errorType])
  @@map("writing_errors")
}

// ============== GRAMMAR MODULE ==============
model GrammarLesson {
  id              String   @id @default(cuid())
  slug            String   @unique          // "a1-l01-alphabet"
  level           String                    // A1, A2, B1
  lessonNumber    Int      @map("lesson_number")
  
  // Titles (bilingual)
  titleDe         String   @map("title_de")
  titleEn         String   @map("title_en")
  titleVi         String   @map("title_vi")
  
  // Content (JSON for flexibility)
  objectives      Json                      // { de:[], en:[], vi:[] }
  theoryContent   Json     @map("theory_content")  // Structured content
  
  // Metadata
  estimatedMinutes Int     @default(25) @map("estimated_minutes")
  prerequisiteIds String[] @default([]) @map("prerequisite_ids")
  order           Int      @default(0)
  isActive        Boolean  @default(true) @map("is_active")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  exercises       GrammarExercise[]
  progress        GrammarProgress[]
  
  @@index([level, order])
  @@map("grammar_lessons")
}

model GrammarExercise {
  id              String   @id @default(cuid())
  lessonId        String   @map("lesson_id")
  lesson          GrammarLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  exerciseType    String   @map("exercise_type")  // mcq, fill_blank, reorder, translate, error_correct
  order           Int      @default(0)
  
  // Content (bilingual)
  questionDe      String?  @map("question_de")
  questionEn      String?  @map("question_en")
  questionVi      String?  @map("question_vi")
  
  // Answer data (JSON - varies by type)
  answerData      Json     @map("answer_data")
  // MCQ: { options: [], correctIndex: 0 }
  // Fill: { blanks: [{ answer: "", alternatives: [] }] }
  // Reorder: { correctOrder: [] }
  // Translate: { acceptedAnswers: [] }
  // Error: { originalText: "", correctedText: "", errorPosition: 0 }
  
  explanation     Json?                     // { de:, en:, vi: }
  points          Int      @default(1)
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([lessonId, order])
  @@map("grammar_exercises")
}

model GrammarProgress {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId        String    @map("lesson_id")
  lesson          GrammarLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  status          String    @default("not_started")  // not_started, in_progress, completed
  score           Float?                              // 0-100
  correctCount    Int       @default(0) @map("correct_count")
  totalAttempts   Int       @default(0) @map("total_attempts")
  
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  lastAttemptAt   DateTime? @map("last_attempt_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@unique([userId, lessonId])
  @@index([userId])
  @@index([userId, status])
  @@map("grammar_progress")
}
