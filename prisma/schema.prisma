generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  passwordHash    String            @map("password_hash")
  name            String?
  avatar          String?
  isActive        Boolean           @default(true) @map("is_active")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  role            String            @default("user")
  favorites       Favorite[]
  gameSessions    GameSession[]
  grammarProgress GrammarProgress[]
  history         History[]
  personalWords   PersonalWord[]
  progress        Progress[]
  refreshTokens   RefreshToken[]
  settings        Settings?
  topicProgress   TopicProgress[]
  writingSessions     WritingSession[]
  readingSessions     ReadingSession[]
  examReadingSessions  ExamReadingSession[]
  examWritingSessions  ExamWritingSession[]
  listeningSessions    ListeningSession[]
  examListeningSessions  ExamListeningSession[]
  examSpeakingSessions   ExamSpeakingSession[]
  freeSpeakingSessions   FreeSpeakingSession[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Settings {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id")
  theme            String   @default("system")
  soundEnabled     Boolean  @default(true) @map("sound_enabled")
  vibrationEnabled Boolean  @default(true) @map("vibration_enabled")
  dailyGoal        Int      @default(20) @map("daily_goal")
  preferredLevel   String   @default("A1") @map("preferred_level")
  showVietnamese   Boolean  @default(true) @map("show_vietnamese")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("settings")
}

model Word {
  id            String       @id @default(cuid())
  word          String
  article       String
  gender        String
  plural        String?
  pronunciation String?
  imageUrl      String?      @map("image_url")
  translationEn String       @map("translation_en")
  translationVi String?      @map("translation_vi")
  category      String
  level         String
  frequency     Int          @default(0)
  examples      String[]
  tips          String[]
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  favorites     Favorite[]
  gameAnswers   GameAnswer[]
  history       History[]
  progress      Progress[]
  topicWords    TopicWord[]

  @@index([gender])
  @@index([category])
  @@index([level])
  @@index([word])
  @@map("words")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  wordId    String   @map("word_id")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@map("favorites")
}

model History {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  wordId   String   @map("word_id")
  viewedAt DateTime @default(now()) @map("viewed_at")
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word     Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@map("history")
}

model GameSession {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  gameType       String       @map("game_type")
  difficulty     String
  category       String?
  score          Int          @default(0)
  correctAnswers Int          @default(0) @map("correct_answers")
  wrongAnswers   Int          @default(0) @map("wrong_answers")
  totalQuestions Int          @default(0) @map("total_questions")
  bestStreak     Int          @default(0) @map("best_streak")
  startedAt      DateTime     @default(now()) @map("started_at")
  endedAt        DateTime?    @map("ended_at")
  duration       Int?
  answers        GameAnswer[]
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, gameType])
  @@index([userId, startedAt])
  @@map("game_sessions")
}

model GameAnswer {
  id             String      @id @default(cuid())
  sessionId      String      @map("session_id")
  wordId         String      @map("word_id")
  selectedAnswer String      @map("selected_answer")
  correctAnswer  String      @map("correct_answer")
  isCorrect      Boolean     @map("is_correct")
  responseTime   Int         @map("response_time")
  createdAt      DateTime    @default(now()) @map("created_at")
  session        GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  word           Word        @relation(fields: [wordId], references: [id])

  @@index([sessionId])
  @@map("game_answers")
}

model Progress {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  wordId       String    @map("word_id")
  easeFactor   Float     @default(2.5) @map("ease_factor")
  interval     Int       @default(0)
  repetitions  Int       @default(0)
  nextReviewAt DateTime  @default(now()) @map("next_review_at")
  lastReviewAt DateTime? @map("last_review_at")
  totalReviews Int       @default(0) @map("total_reviews")
  correctCount Int       @default(0) @map("correct_count")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  word         Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId, nextReviewAt])
  @@map("progress")
}

model PersonalWord {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  word            String
  wordType        String    @map("word_type")
  nomenData       Json?     @map("nomen_data")
  verbData        Json?     @map("verb_data")
  adjektivData    Json?     @map("adjektiv_data")
  prapositionData Json?     @map("praposition_data")
  translationEn   String    @map("translation_en")
  translationVi   String    @map("translation_vi")
  examples        String[]  @default([])
  level           String    @default("A1")
  category        String?
  tags            String[]  @default([])
  notes           String?
  pronunciation   String?
  isFavorite      Boolean   @default(false) @map("is_favorite")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  correctCount    Int       @default(0) @map("correct_count")
  easeFactor      Float     @default(2.5) @map("ease_factor")
  interval        Int       @default(0)
  lastReviewAt    DateTime? @map("last_review_at")
  nextReviewAt    DateTime  @default(now()) @map("next_review_at")
  repetitions     Int       @default(0)
  totalReviews    Int       @default(0) @map("total_reviews")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, word, wordType])
  @@index([userId])
  @@index([userId, wordType])
  @@index([userId, level])
  @@index([userId, isFavorite])
  @@index([userId, nextReviewAt])
  @@map("personal_words")
}

model Topic {
  id            String          @id @default(cuid())
  slug          String          @unique
  nameDe        String          @map("name_de")
  nameEn        String          @map("name_en")
  nameVi        String          @map("name_vi")
  descriptionDe String?         @map("description_de")
  descriptionEn String?         @map("description_en")
  descriptionVi String?         @map("description_vi")
  icon          String?
  color         String?
  imageUrl      String?         @map("image_url")
  level         String          @default("A1")
  order         Int             @default(0)
  isActive      Boolean         @default(true) @map("is_active")
  wordCount     Int             @default(0) @map("word_count")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  type          String          @default("general")
  userProgress  TopicProgress[]
  topicWords    TopicWord[]

  @@index([level])
  @@index([order])
  @@map("topics")
}

model TopicWord {
  id        String   @id @default(cuid())
  topicId   String   @map("topic_id")
  wordId    String   @map("word_id")
  order     Int      @default(0)
  isCore    Boolean  @default(false) @map("is_core")
  createdAt DateTime @default(now()) @map("created_at")
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([topicId, wordId])
  @@index([topicId])
  @@index([wordId])
  @@map("topic_words")
}

model TopicProgress {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  topicId        String    @map("topic_id")
  wordsLearned   Int       @default(0) @map("words_learned")
  wordsTotal     Int       @default(0) @map("words_total")
  masteryPercent Float     @default(0) @map("mastery_percent")
  lastStudiedAt  DateTime? @map("last_studied_at")
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  topic          Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@map("topic_progress")
}

model WritingSession {
  id            String         @id @default(cuid())
  userId        String         @map("user_id")
  topic         String
  cefrLevel     String         @map("cefr_level")
  writingType   String         @map("writing_type")
  wordCountMin  Int            @map("word_count_min")
  wordCountMax  Int            @map("word_count_max")
  prompt        String
  vocabHints    Json?          @map("vocab_hints")
  grammarHints  Json?          @map("grammar_hints")
  userText      String?        @map("user_text")
  wordCount     Int?           @map("word_count")
  submittedAt   DateTime?      @map("submitted_at")
  overallScore  Float?         @map("overall_score")
  correctedText String?        @map("corrected_text")
  feedbackDe    String?        @map("feedback_de")
  feedbackVi    String?        @map("feedback_vi")
  strengths     Json?
  improvements  Json?
  gradedAt      DateTime?      @map("graded_at")
  status        String         @default("DRAFT")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  errors        WritingError[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("writing_sessions")
}

model WritingError {
  id               String         @id @default(cuid())
  writingSessionId String         @map("writing_session_id")
  errorType        String         @map("error_type")
  severity         String
  originalText     String         @map("original_text")
  correctedText    String         @map("corrected_text")
  explanationDe    String         @map("explanation_de")
  explanationVi    String         @map("explanation_vi")
  position         Int?
  createdAt        DateTime       @default(now()) @map("created_at")
  session          WritingSession @relation(fields: [writingSessionId], references: [id], onDelete: Cascade)

  @@index([writingSessionId])
  @@index([errorType])
  @@map("writing_errors")
}

model GrammarLesson {
  id               String            @id @default(cuid())
  slug             String            @unique
  level            String
  lessonNumber     Int               @map("lesson_number")
  titleDe          String            @map("title_de")
  titleEn          String            @map("title_en")
  titleVi          String            @map("title_vi")
  objectives       Json
  theoryContent    Json              @map("theory_content")
  estimatedMinutes Int               @default(25) @map("estimated_minutes")
  prerequisiteIds  String[]          @default([]) @map("prerequisite_ids")
  order            Int               @default(0)
  isActive         Boolean           @default(true) @map("is_active")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  exercises        GrammarExercise[]
  progress         GrammarProgress[]

  @@index([level, order])
  @@map("grammar_lessons")
}

model GrammarExercise {
  id           String        @id @default(cuid())
  lessonId     String        @map("lesson_id")
  exerciseType String        @map("exercise_type")
  order        Int           @default(0)
  questionDe   String?       @map("question_de")
  questionEn   String?       @map("question_en")
  questionVi   String?       @map("question_vi")
  answerData   Json          @map("answer_data")
  explanation  Json?
  points       Int           @default(1)
  createdAt    DateTime      @default(now()) @map("created_at")
  lesson       GrammarLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId, order])
  @@map("grammar_exercises")
}

model GrammarProgress {
  id            String        @id @default(cuid())
  userId        String        @map("user_id")
  lessonId      String        @map("lesson_id")
  status        String        @default("not_started")
  score         Float?
  correctCount  Int           @default(0) @map("correct_count")
  totalAttempts Int           @default(0) @map("total_attempts")
  startedAt     DateTime?     @map("started_at")
  completedAt   DateTime?     @map("completed_at")
  lastAttemptAt DateTime?     @map("last_attempt_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  lesson        GrammarLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([userId, status])
  @@map("grammar_progress")
}

model ReadingSession {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  cefrLevel       String    @map("cefr_level")
  topic           String
  textType        String    @map("text_type")
  title           String
  passage         String
  questions       Json
  vocabHighlights Json?     @map("vocab_highlights")
  userAnswers     Json?     @map("user_answers")
  score           Float?
  totalQuestions  Int       @map("total_questions")
  correctCount    Int       @default(0) @map("correct_count")
  gradingDetails  Json?     @map("grading_details")
  status          String    @default("DRAFT")
  submittedAt     DateTime? @map("submitted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("reading_sessions")
}

model ExamReadingSession {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  examType       String    @map("exam_type")
  cefrLevel      String    @map("cefr_level")
  teile          Json
  userAnswers    Json?     @map("user_answers")
  teilScores     Json?     @map("teil_scores")
  score          Float?
  totalQuestions Int       @map("total_questions")
  correctCount   Int       @default(0) @map("correct_count")
  gradingDetails Json?     @map("grading_details")
  status         String    @default("DRAFT")
  submittedAt    DateTime? @map("submitted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("exam_reading_sessions")
}

model ExamWritingSession {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  examType    String    @map("exam_type")
  cefrLevel   String    @map("cefr_level")
  teile       Json
  userTexts   Json?     @map("user_texts")
  grading     Json?
  totalScore  Float?    @map("total_score")
  status      String    @default("DRAFT")
  submittedAt DateTime? @map("submitted_at")
  gradedAt    DateTime? @map("graded_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("exam_writing_sessions")
}

model ListeningSession {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  cefrLevel    String    @map("cefr_level")
  scriptType   String    @map("script_type")
  title        String
  transcript   String
  questions    Json
  userAnswers  Json?     @map("user_answers")
  score        Float?
  correctCount Int       @default(0) @map("correct_count")
  totalQ       Int       @default(0) @map("total_q")
  status       String    @default("DRAFT")
  submittedAt  DateTime? @map("submitted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("listening_sessions")
}

model ExamListeningSession {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  examType       String    @map("exam_type")
  cefrLevel      String    @map("cefr_level")
  teile          Json
  userAnswers    Json?     @map("user_answers")
  teilScores     Json?     @map("teil_scores")
  score          Float?
  totalQuestions Int       @map("total_questions")
  correctCount   Int       @default(0) @map("correct_count")
  gradingDetails Json?     @map("grading_details")
  status         String    @default("DRAFT")
  submittedAt    DateTime? @map("submitted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("exam_listening_sessions")
}

model ExamSpeakingSession {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  examType        String    @map("exam_type")        // GOETHE | TELC
  cefrLevel       String    @map("cefr_level")        // A1 | A2 | B1
  teile           Json                               // ExamSpeakingTeil[]
  userTranscripts Json?     @map("user_transcripts") // { "1": "Ich hei√üe...", "2": "..." }
  grading         Json?                              // { "1": TeilGrading, "2": ... }
  totalScore      Float?    @map("total_score")
  status          String    @default("DRAFT")         // DRAFT | GRADING | GRADED | ERROR
  submittedAt     DateTime? @map("submitted_at")
  gradedAt        DateTime? @map("graded_at")
  createdAt       DateTime  @default(now())           @map("created_at")
  updatedAt       DateTime  @updatedAt                @map("updated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("exam_speaking_sessions")
}

model FreeSpeakingSession {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  cefrLevel      String    @map("cefr_level")      // A1 | A2 | B1
  topicType      String    @map("topic_type")       // sich_vorstellen | alltag | ...
  prompt         String                             // German instruction/question
  promptVi       String    @map("prompt_vi")        // Vietnamese translation
  keyPoints      Json      @map("key_points")       // string[]
  transcript     String?                            // Web Speech API result
  grading        Json?                              // FreeSpeakingGrading
  totalScore     Float?    @map("total_score")
  status         String    @default("DRAFT")        // DRAFT | GRADING | GRADED | ERROR
  submittedAt    DateTime? @map("submitted_at")
  gradedAt       DateTime? @map("graded_at")
  createdAt      DateTime  @default(now())          @map("created_at")
  updatedAt      DateTime  @updatedAt               @map("updated_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("free_speaking_sessions")
}
